global:
  scrape_interval: 60s
  scrape_timeout: 10s
  evaluation_interval: 15s
  external_labels:
    monitor: 'kolla'

{% if prometheus_alert_rules is defined and prometheus_alert_rules.files | length  > 0 %}
rule_files:
{% for rule in prometheus_alert_rules.files %}
  - "/etc/prometheus/{{ rule.path | basename }}"
{% endfor %}
{% endif %}

scrape_configs:
  - job_name: prometheus
    static_configs:
      - targets:
{% for host in groups['prometheus'] %}
        - '{{ 'api' | kolla_address(host) | put_address_in_context('url') }}:{{ prometheus_port }}'
{% endfor %}

{% if enable_prometheus_node_exporter | bool %}
  - job_name: node
    static_configs:
      - targets:
{% for host in groups['prometheus-node-exporter'] %}
        - '{{ 'external' | kolla_address(host) | put_address_in_context('url') }}:{{ hostvars[host]['prometheus_node_exporter_port'] }}'
{% endfor %}
{% endif %}

{% if enable_prometheus_mysqld_exporter | bool %}
  - job_name: mysqld
    static_configs:
      - targets:
{% for host in groups['prometheus-mysqld-exporter'] %}
        - '{{ 'external' | kolla_address(host) | put_address_in_context('url') }}:{{ hostvars[host]['prometheus_mysqld_exporter_port'] }}'
{% endfor %}
{% endif %}

{% if enable_prometheus_haproxy_exporter | bool %}
  - job_name: haproxy
    static_configs:
      - targets:
{% for host in groups['prometheus-haproxy-exporter'] %}
        - '{{ 'external' | kolla_address(host) | put_address_in_context('url') }}:{{ hostvars[host]['prometheus_haproxy_exporter_port'] }}'
{% endfor %}
{% endif %}

{% if enable_prometheus_memcached_exporter | bool %}
  - job_name: memcached
    static_configs:
      - targets:
{% for host in groups['prometheus-memcached-exporter'] %}
        - '{{ 'external' | kolla_address(host) | put_address_in_context('url') }}:{{ hostvars[host]['prometheus_memcached_exporter_port'] }}'
{% endfor %}
{% endif %}

{% if enable_prometheus_cadvisor | bool %}
  - job_name: cadvisor
    static_configs:
      - targets:
{% for host in groups["prometheus-cadvisor"] %}
        - '{{ 'external' | kolla_address(host) | put_address_in_context('url') }}:{{ hostvars[host]['prometheus_cadvisor_port'] }}'
{% endfor %}
{% endif %}

{% if enable_prometheus_process_exporter | bool %}
  - job_name: process_exporter
    static_configs:
      - targets:
{% for host in groups['prometheus-process-exporter'] | sort %}
        - '{{ hostvars[host]['ansible_' + hostvars[host]['api_interface']]['ipv4']['address'] }}:{{ hostvars[host]['prometheus_process_exporter_port'] }}'
{% endfor %}
{% endif %}

{% if enable_prometheus_ceph_mgr_exporter | bool %}
  - job_name: ceph_mgr_exporter
    honor_labels: true
    static_configs:
      - targets:
{% for host in groups["ceph-mgr"] %}
        - '{{ 'external' | kolla_address(host) | put_address_in_context('url') }}:{{ hostvars[host]['prometheus_ceph_mgr_exporter_port'] }}'
{% endfor %}
{% endif %}

{% if enable_prometheus_openstack_exporter | bool %}
  - job_name: openstack_exporter
    scrape_interval: {{ prometheus_openstack_exporter_interval }}
    honor_labels: true
    static_configs:
      - targets:
{% for host in groups["prometheus-openstack-exporter"] %}
        - '{{ 'external' | kolla_address(host) | put_address_in_context('url') }}:{{ hostvars[host]['prometheus_openstack_exporter_port'] }}'
{% endfor %}
{% endif %}

{% if enable_prometheus_rabbitmq_exporter | bool %}
  - job_name: rabbitmq_exporter
    scrape_interval: {{ prometheus_rabbitmq_exporter_scrape_interval }}
    scrape_timeout: {{ prometheus_rabbitmq_exporter_timeout }}
    static_configs:
      - targets:
{% for host in groups['prometheus-rabbitmq-exporter'] | sort %}
        - '{{ hostvars[host]['ansible_' + hostvars[host]['external_interface']]['ipv4']['address'] }}:{{ hostvars[host]['prometheus_rabbitmq_exporter_port'] }}'
{% endfor %}
{% endif %}


{% if enable_prometheus_elasticsearch_exporter | bool %}
  - job_name: elasticsearch_exporter
    scrape_interval: {{ prometheus_elasticsearch_exporter_interval }}
    static_configs:
      - targets:
{% for host in groups["prometheus-elasticsearch-exporter"] %}
        - '{{ 'external' | kolla_address(host) | put_address_in_context('url') }}:{{ hostvars[host]['prometheus_elasticsearch_exporter_port'] }}'
{% endfor %}
{% endif %}

{% if enable_prometheus_blackbox_exporter | bool and prometheus_blackbox_exporter_endpoints | length > 0 | bool %}
  - job_name: blackbox_exporter
    metrics_path: /probe
    honor_labels: true
    static_configs:
      - targets:
{% for target in prometheus_blackbox_exporter_endpoints %}
        - '{{ target }}'
{% endfor %}
    relabel_configs:
      - source_labels: [__address__]
        regex: (\w+):(\w+):(.+)
        target_label: service
        replacement: ${1}
      - source_labels: [__address__]
        regex: (\w+):(\w+):(.+)
        target_label: __param_module
        replacement: ${2}
      - source_labels: [__param_module]
        target_label: module
      - source_labels: [__address__]
        regex: (\w+):(\w+):(.+)
        target_label: __param_target
        replacement: ${3}
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: '{{ external_interface_address | put_address_in_context('url') }}:{{ prometheus_blackbox_exporter_port }}'
{% endif %}

{% if enable_prometheus_container_status_exporter | bool %}
  - job_name: host-container-state
    scrape_interval: 30s
    static_configs:
      - targets:
{% for host in groups['prometheus-container-status-exporter'] %}
        - '{{ hostvars[host]['ansible_' + hostvars[host]['api_interface']]['ipv4']['address'] }}:{{ hostvars[host]['prometheus_container_status_exporter_port'] }}'
{% endfor %}
{% endif %}

{% if enable_prometheus_alertmanager | bool %}
alerting:
  alertmanagers:
  - static_configs:
    - targets:
{% for host in groups["prometheus-alertmanager"] %}
        - '{{ 'api' | kolla_address(host) | put_address_in_context('url') }}:{{ hostvars[host]['prometheus_alertmanager_port'] }}'
{% endfor %}
{% endif %}
